{%- if settings.enable_tracking -%}
  <!-- HRL Traffic Tracking Script -->
  <script>
    (function() {
      'use strict';
      
      // App configuration
      const CONFIG = {
        shop: '{{ shop.permanent_domain }}',
        appUrl: '{{ settings.app_proxy_subpath | default: "app-proxy" }}',
        endpoints: {
          collect: '/apps/{{ settings.app_proxy_subpath | default: "app-proxy" }}/collect',
          config: '/apps/{{ settings.app_proxy_subpath | default: "app-proxy" }}/config'
        },
        features: {
          activeUsers: true,
          pageViews: true,
          sessions: true
        },
        settings: {
          heartbeatInterval: 30000,
          sessionTimeout: 1800000
        }
      };
      
      // Generate unique IDs
      function generateId() {
        return 'hrl_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
      }
      
      // Get or create visitor ID
      function getVisitorId() {
        let visitorId = localStorage.getItem('hrl_visitor_id');
        if (!visitorId) {
          visitorId = generateId();
          localStorage.setItem('hrl_visitor_id', visitorId);
        }
        return visitorId;
      }
      
      // Get or create session ID
      function getSessionId() {
        let sessionId = sessionStorage.getItem('hrl_session_id');
        if (!sessionId) {
          sessionId = generateId();
          sessionStorage.setItem('hrl_session_id', sessionId);
        }
        return sessionId;
      }
      
      // Send tracking data
      function sendTrackingData(eventType, data) {
        const payload = {
          event_type: eventType,
          data: {
            ...data,
            visitor_id: getVisitorId(),
            session_id: getSessionId(),
            shop: CONFIG.shop,
            page_path: window.location.pathname,
            page_title: document.title,
            referrer: document.referrer,
            timestamp: Date.now()
          }
        };
        
        // Use sendBeacon for better reliability
        if (navigator.sendBeacon) {
          navigator.sendBeacon(CONFIG.endpoints.collect, JSON.stringify(payload));
        } else {
          fetch(CONFIG.endpoints.collect, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          }).catch(err => console.warn('HRL Tracking error:', err));
        }
      }
      
      // Track page view
      function trackPageView() {
        sendTrackingData('page_view', {
          page_path: window.location.pathname,
          page_title: document.title,
          referrer: document.referrer
        });
      }
      
      // Track page unload
      function trackPageUnload() {
        sendTrackingData('page_unload', {
          page_path: window.location.pathname,
          duration_ms: Date.now() - (window.hrlPageStart || Date.now())
        });
      }
      
      // Start heartbeat
      function startHeartbeat() {
        if (!CONFIG.features.activeUsers) return;
        
        function sendHeartbeat() {
          sendTrackingData('heartbeat', {
            page_path: window.location.pathname
          });
        }
        
        // Send initial heartbeat
        sendHeartbeat();
        
        // Set up periodic heartbeat
        const heartbeatInterval = setInterval(sendHeartbeat, CONFIG.settings.heartbeatInterval);
        
        // Clean up on page unload
        window.addEventListener('beforeunload', function() {
          clearInterval(heartbeatInterval);
          trackPageUnload();
        });
      }
      
      // Initialize tracking
      function init() {
        // Mark page start time
        window.hrlPageStart = Date.now();
        
        // Track page view
        if (CONFIG.features.pageViews) {
          trackPageView();
        }
        
        // Start heartbeat for active users
        if (CONFIG.features.activeUsers) {
          startHeartbeat();
        }
        
        // Track page unload
        window.addEventListener('beforeunload', trackPageUnload);
        
        // Track page visibility changes
        document.addEventListener('visibilitychange', function() {
          if (document.hidden) {
            trackPageUnload();
          } else {
            window.hrlPageStart = Date.now();
            if (CONFIG.features.pageViews) {
              trackPageView();
            }
          }
        });
      }
      
      // Start tracking when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
      
      // Global namespace for debugging
      window.HRLTracking = {
        config: CONFIG,
        getVisitorId: getVisitorId,
        getSessionId: getSessionId,
        isLoaded: function() { return true; }
      };
      
    })();
  </script>
  
  <!-- HRL Tracking Utilities -->
  <script defer src="{{ 'tracking.js' | asset_url }}?v={{ settings.script_version | default: 1 }}"></script>
{%- endif -%}

{% schema %}
{
  "name": "HRL Tracking",
  "target": "head",
  "settings": [
    { "type": "text", "id": "app_proxy_subpath", "label": "App Proxy Subpath", "default": "app-proxy" },
    { "type": "checkbox", "id": "enable_tracking", "label": "Enable", "default": true },
    { "type": "text", "id": "script_version", "label": "Script Version", "default": "1" }
  ]
}
{% endschema %}
{% comment %} theme-check-disable AssetUrlFilters RemoteAsset {% endcomment %}
<script id="hrl-app-proxy" defer>
  // HRL Traffic Tracking - Inline Script
  (function () {
    'use strict';

    // ---- helpers -------------------------------------------------------------
    function uid(prefix) {
      return `${prefix}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
    }

    function getOrSetLS(key, gen) {
      let v = localStorage.getItem(key);
      if (!v) {
        v = gen();
        localStorage.setItem(key, v);
      }
      return v;
    }

    // ---- bootstrap element & endpoints --------------------------------------
    var scriptEl = document.getElementById('hrl-app-proxy');
    if (!scriptEl) {
      console.warn('HRL Tracking: bootstrap script element not found');
      return;
    }

    // Shop bilgisini URL'den al
    var shop = '{{ shop.permanent_domain }}';
    var basePath = '/app-proxy';
    var ORIGIN = 'https://traffic-takip-production.up.railway.app';

    // ---- config & state -----------------------------------------------------
    var HRL = {
      config: {
        shop: shop,
        endpoints: {
          config: ORIGIN + basePath + '/config.json?shop=' + encodeURIComponent(shop),
          collect: ORIGIN + basePath + '/collect',
          sessionStart: ORIGIN + '/api/sessions/start',
          sessionEnd: ORIGIN + '/api/sessions/end',
          sessionUpdate: ORIGIN + '/api/sessions/update'
        }
      },
      visitorId: getOrSetLS('hrl_visitor_id', function() { return uid('visitor'); }),
      sessionId: getOrSetLS('hrl_session_id', function() { return uid('session'); }),
      initialized: false,
      currentSession: null,
      sessionStartTime: null
    };

    // ---- tracking functions -------------------------------------------------
    function payload(type, extra) {
      return Object.assign({
        type: type,
        shop: HRL.config.shop,
        visitor_id: HRL.visitorId,
        session_id: HRL.sessionId,
        page_path: location.pathname,
        page_title: document.title,
        referrer: document.referrer,
        timestamp: Date.now(),
        user_agent: navigator.userAgent,
        lang: navigator.language
      }, extra || {});
    }

    function send(data) {
      console.log('HRL Tracking: Sending data', data);
      fetch(HRL.config.endpoints.collect, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
        credentials: 'omit'
      }).then(function(response) {
        console.log('HRL Tracking: Response received', response.status, response.statusText);
        return response.json();
      }).then(function(data) {
        console.log('HRL Tracking: Data processed', data);
      }).catch(function(error) {
        console.warn('HRL Tracking: Send error', error);
      });
    }

    function track(type, extra) {
      send(payload(type, extra));
    }

    // ---- session management -------------------------------------------------
    function startSession() {
      if (HRL.currentSession) return; // Session already started
      
      HRL.sessionStartTime = Date.now();
      const sessionData = {
        shop: HRL.config.shop,
        visitor_id: HRL.visitorId,
        page_path: location.pathname,
        referrer: document.referrer,
        user_agent: navigator.userAgent,
        ip_hash: 'unknown' // Will be set by server
      };

      console.log('HRL Tracking: Starting session', sessionData);
      
      fetch(HRL.config.endpoints.sessionStart, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sessionData)
      }).then(response => response.json()).then(data => {
        if (data.success) {
          HRL.currentSession = data.session_id;
          console.log('HRL Tracking: Session started', data);
        }
      }).catch(error => {
        console.warn('HRL Tracking: Session start error', error);
      });
    }

    function endSession() {
      if (!HRL.currentSession) return;
      
      const sessionData = {
        shop: HRL.config.shop,
        visitor_id: HRL.visitorId,
        session_id: HRL.currentSession,
        last_page: location.pathname
      };

      console.log('HRL Tracking: Ending session', sessionData);
      
      fetch(HRL.config.endpoints.sessionEnd, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sessionData)
      }).then(response => response.json()).then(data => {
        console.log('HRL Tracking: Session ended', data);
        HRL.currentSession = null;
      }).catch(error => {
        console.warn('HRL Tracking: Session end error', error);
      });
    }

    function updateSession() {
      if (!HRL.currentSession) return;
      
      const sessionData = {
        shop: HRL.config.shop,
        visitor_id: HRL.visitorId,
        session_id: HRL.currentSession,
        page_path: location.pathname
      };

      fetch(HRL.config.endpoints.sessionUpdate, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(sessionData)
      }).catch(error => {
        console.warn('HRL Tracking: Session update error', error);
      });
    }

    // ---- heartbeat ----------------------------------------------------------
    var hbTimer = null;
    var startTs = Date.now();
    function startHeartbeat() {
      // Start session first
      startSession();
      
      // ilk nabÄ±z
      track('heartbeat', { since_ms: 0 });
      // periyodik
      hbTimer = setInterval(function () {
        track('heartbeat', { since_ms: Date.now() - startTs });
        updateSession(); // Update session on each heartbeat
      }, 10000); // 10 saniye
    }

    function stopHeartbeat() {
      if (hbTimer) {
        clearInterval(hbTimer);
        hbTimer = null;
      }
      // End session when stopping heartbeat
      endSession();
    }

    // ---- page tracking ------------------------------------------------------
    function trackPageView() {
      track('page_view');
    }

    function trackPageUnload() {
      track('page_unload', { since_ms: Date.now() - startTs });
    }

    // ---- initialization -----------------------------------------------------
    function init() {
      if (HRL.initialized) return;
      
      console.log('HRL Tracking: Initializing...');
      
      // Page view
      trackPageView();
      
      // Heartbeat
      startHeartbeat();
      
      // Page unload
      window.addEventListener('beforeunload', function() {
        trackPageUnload();
        endSession(); // End session on page unload
      });
      
      HRL.initialized = true;
      console.log('HRL Tracking: Initialized successfully');
    }

    // ---- auto-start ---------------------------------------------------------
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    // ---- global API ---------------------------------------------------------
    window.HRL = {
      track: track,
      config: HRL.config,
      initialized: function() { return HRL.initialized; },
      startSession: startSession,
      endSession: endSession,
      updateSession: updateSession
    };

  })();
</script>
{% comment %} theme-check-enable AssetUrlFilters RemoteAsset {% endcomment %}

{% schema %}
{
  "name": "HRL Tracking",
  "target": "head",
  "settings": [
    { "type": "text", "id": "app_proxy_subpath", "label": "App Proxy Subpath", "default": "app-proxy" },
    { "type": "text", "id": "script_version", "label": "Script Version", "default": "1" }
  ]
}
{% endschema %}
